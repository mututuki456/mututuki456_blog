---
// 最初の <pre> 要素にしか適用されないバグが発生中
---

<script>
  // AstroのViewTransitions（page-load）と通常の読み込み（DOMContentLoaded）の両対応
  document.addEventListener('astro:page-load', setupCodeCopy);
  document.addEventListener('DOMContentLoaded', setupCodeCopy);

  function setupCodeCopy() {
    const preTags = document.querySelectorAll('pre');

    preTags.forEach((pre) => {
      // 【修正ポイント】
      // 親要素を探すのではなく、preタグ自体にフラグがあるかで判定する
      if (pre.getAttribute('data-processed') === 'true') return;

      // 1. ラッパー作成
      const wrapper = document.createElement('div');
      wrapper.className = 'relative group mb-4';

      // 2. ラッパーを挿入 & preを移動
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // 【修正ポイント】処理済みフラグを立てる
      pre.setAttribute('data-processed', 'true');

      // 3. ボタン作成
      const button = document.createElement('button');
      // クラス名は変更なし
      button.className = `
        copy-btn
        absolute top-2 right-2 
        p-2 rounded-md 
        bg-gray-800 text-gray-400 
        border border-gray-600
        opacity-0 group-hover:opacity-100 focus:opacity-100
        transition-all duration-200
        hover:bg-gray-700 hover:text-white
        z-10
      `;
      button.setAttribute('aria-label', 'Copy code');

      button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      `;

      // 4. クリックイベント
      button.addEventListener('click', async () => {
        try {
          const code = pre.querySelector('code')?.innerText || pre.innerText;
          await navigator.clipboard.writeText(code);

          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
          button.classList.add('border-green-500', 'text-green-500'); // 色味も少し調整

          setTimeout(() => {
            button.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            `;
            button.classList.remove('border-green-500', 'text-green-500');
          }, 2000);

        } catch (err) {
          console.error('Failed to copy!', err);
        }
      });

      wrapper.appendChild(button);
    });
  }
</script>